#!/usr/bin/env python3
"""
UAE Legal GraphRAG - Comprehensive Cleanup Script
=================================================

This script performs a thorough cleanup of the entire repository,
removing all unnecessary files and organizing the project structure.

Usage:
    python comprehensive_cleanup.py
"""

import os
import shutil
import subprocess
from pathlib import Path

# Colors for terminal output
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'

def print_header():
    """Print the cleanup header."""
    print(f"{Colors.HEADER}{Colors.BOLD}")
    print("=" * 70)
    print("üßπ UAE Legal GraphRAG - Comprehensive Cleanup Script")
    print("=" * 70)
    print(f"{Colors.ENDC}")

def remove_unnecessary_directories():
    """Remove unnecessary directories."""
    print(f"{Colors.OKCYAN}üóÇÔ∏è  Removing unnecessary directories...{Colors.ENDC}")
    
    directories_to_remove = [
        "test_azure",
        "backend/venv",
        "backend/tests",
        "backend/scripts",
        "frontend/.next",
        "frontend/node_modules",
        ".venv"
    ]
    
    removed_count = 0
    for directory in directories_to_remove:
        dir_path = Path(directory)
        if dir_path.exists():
            try:
                shutil.rmtree(dir_path)
                print(f"  ‚úÖ Removed directory: {directory}")
                removed_count += 1
            except Exception as e:
                print(f"  ‚ùå Failed to remove {directory}: {e}")
    
    print(f"{Colors.OKGREEN}‚úÖ Removed {removed_count} unnecessary directories{Colors.ENDC}")
    return True

def remove_unnecessary_files():
    """Remove unnecessary files."""
    print(f"{Colors.OKCYAN}üóëÔ∏è  Removing unnecessary files...{Colors.ENDC}")
    
    files_to_remove = [
        # Test and debug files
        "backend/test_azure_openai.py",
        "test_azure_openai.py",
        "debug_neo4j_data.py",
        "test_fixes.py",
        "test_complex_backend.py",
        "debug_backend.py",
        "test_analysis_page.py",
        "final_verification_test.py",
        "final_comprehensive_test.py",
        "test_overview_page.py",
        "test_simple_query.py",
        "test_graphrag_with_data.py",
        
        # Old startup scripts
        "start_backend.py",
        "start_complex_backend.py",
        
        # Duplicate and backup files
        "frontend/.env.backup",
        "frontend/.env.example",
        "STARTUP_GUIDE.md",
        
        # Build and cache files
        "frontend/next-env.d.ts",
        "frontend/.eslintrc.json",
        "backend/pyproject.toml",
        "backend/Dockerfile",
        
        # Temporary files
        "*.tmp",
        "*.temp",
        "*.log",
        "*.pyc",
        "__pycache__",
        "*.egg-info",
        ".pytest_cache",
        ".coverage",
        "htmlcov",
        ".mypy_cache",
        ".dmypy.json",
        "dmypy.json",
        ".pyre",
        ".ropeproject",
        ".spyderproject",
        ".spyproject",
        ".ipynb_checkpoints",
        ".DS_Store",
        ".DS_Store?",
        "._*",
        ".Spotlight-V100",
        ".Trashes",
        "ehthumbs.db",
        "Thumbs.db",
        "*.swp",
        "*.swo",
        "*~"
    ]
    
    removed_count = 0
    for file_pattern in files_to_remove:
        if "*" in file_pattern:
            # Handle glob patterns
            for file_path in Path(".").glob(file_pattern):
                try:
                    if file_path.is_file():
                        file_path.unlink()
                        print(f"  ‚úÖ Removed: {file_path}")
                        removed_count += 1
                    elif file_path.is_dir():
                        shutil.rmtree(file_path)
                        print(f"  ‚úÖ Removed directory: {file_path}")
                        removed_count += 1
                except Exception as e:
                    print(f"  ‚ùå Failed to remove {file_path}: {e}")
        else:
            # Handle specific files
            file_path = Path(file_pattern)
            if file_path.exists():
                try:
                    if file_path.is_file():
                        file_path.unlink()
                        print(f"  ‚úÖ Removed: {file_pattern}")
                        removed_count += 1
                    elif file_path.is_dir():
                        shutil.rmtree(file_path)
                        print(f"  ‚úÖ Removed directory: {file_pattern}")
                        removed_count += 1
                except Exception as e:
                    print(f"  ‚ùå Failed to remove {file_pattern}: {e}")
    
    print(f"{Colors.OKGREEN}‚úÖ Removed {removed_count} unnecessary files{Colors.ENDC}")
    return True

def clean_frontend_directory():
    """Clean up frontend directory."""
    print(f"{Colors.OKCYAN}üßπ Cleaning frontend directory...{Colors.ENDC}")
    
    # Remove unnecessary frontend files
    frontend_files_to_remove = [
        "frontend/.env.backup",
        "frontend/.env.example",
        "frontend/next-env.d.ts",
        "frontend/.eslintrc.json",
        "frontend/.gitignore"
    ]
    
    removed_count = 0
    for file_path in frontend_files_to_remove:
        if Path(file_path).exists():
            try:
                Path(file_path).unlink()
                print(f"  ‚úÖ Removed: {file_path}")
                removed_count += 1
            except Exception as e:
                print(f"  ‚ùå Failed to remove {file_path}: {e}")
    
    print(f"{Colors.OKGREEN}‚úÖ Cleaned {removed_count} frontend files{Colors.ENDC}")
    return True

def clean_backend_directory():
    """Clean up backend directory."""
    print(f"{Colors.OKCYAN}üßπ Cleaning backend directory...{Colors.ENDC}")
    
    # Remove unnecessary backend files
    backend_files_to_remove = [
        "backend/test_azure_openai.py",
        "backend/pyproject.toml",
        "backend/Dockerfile"
    ]
    
    removed_count = 0
    for file_path in backend_files_to_remove:
        if Path(file_path).exists():
            try:
                Path(file_path).unlink()
                print(f"  ‚úÖ Removed: {file_path}")
                removed_count += 1
            except Exception as e:
                print(f"  ‚ùå Failed to remove {file_path}: {e}")
    
    print(f"{Colors.OKGREEN}‚úÖ Cleaned {removed_count} backend files{Colors.ENDC}")
    return True

def organize_directories():
    """Organize project directories."""
    print(f"{Colors.OKCYAN}üìÅ Organizing directories...{Colors.ENDC}")
    
    # Create necessary directories
    directories_to_create = [
        "docs",
        "scripts",
        "backend/data",
        "backend/logs",
        "logs"
    ]
    
    created_count = 0
    for directory in directories_to_create:
        dir_path = Path(directory)
        if not dir_path.exists():
            try:
                dir_path.mkdir(parents=True, exist_ok=True)
                print(f"  ‚úÖ Created: {directory}")
                created_count += 1
            except Exception as e:
                print(f"  ‚ùå Failed to create {directory}: {e}")
    
    print(f"{Colors.OKGREEN}‚úÖ Created {created_count} directories{Colors.ENDC}")
    return True

def update_gitignore():
    """Update .gitignore file with comprehensive patterns."""
    print(f"{Colors.OKCYAN}üìù Updating .gitignore...{Colors.ENDC}")
    
    gitignore_content = """# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# Virtual Environment
.venv/
venv/
ENV/
env/

# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# Next.js
.next/
out/
build/

# Environment files
.env
.env.local
.env.development.local
.env.test.local
.env.production.local
.env.backup
.env.example

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Logs
*.log
logs/

# Database
*.db
*.sqlite
*.sqlite3

# Temporary files
*.tmp
*.temp
temp/

# Test files
test_*.py
debug_*.py
*_test.py
test_azure/

# Documentation
docs/_build/

# Coverage
.coverage
htmlcov/

# Jupyter Notebook
.ipynb_checkpoints

# pyenv
.python-version

# pipenv
Pipfile.lock

# PEP 582
__pypackages__/

# Celery
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# PyCharm
.idea/

# VS Code
.vscode/

# Temporary files
*.tmp
*.temp
temp/

# Frontend specific
frontend/.next/
frontend/out/
frontend/build/
frontend/node_modules/
frontend/.env.backup
frontend/.env.example
frontend/next-env.d.ts
frontend/.eslintrc.json

# Backend specific
backend/venv/
backend/tests/
backend/scripts/
backend/test_*.py
backend/pyproject.toml
backend/Dockerfile

# Old files
STARTUP_GUIDE.md
start_backend.py
start_complex_backend.py
"""
    
    try:
        with open(".gitignore", 'w') as f:
            f.write(gitignore_content)
        print(f"{Colors.OKGREEN}‚úÖ Updated .gitignore{Colors.ENDC}")
        return True
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå Failed to update .gitignore: {e}{Colors.ENDC}")
        return False

def create_final_structure():
    """Create the final clean project structure."""
    print(f"{Colors.OKCYAN}üèóÔ∏è  Creating final project structure...{Colors.ENDC}")
    
    # Create a summary of the final structure
    structure_content = """# UAE Legal GraphRAG - Final Project Structure

## üìÅ Clean Repository Structure

```
internship_GraphRAG/
‚îú‚îÄ‚îÄ start.py                 # üöÄ Unified startup script
‚îú‚îÄ‚îÄ setup.py                 # üîß Automated setup
‚îú‚îÄ‚îÄ comprehensive_cleanup.py # üßπ Comprehensive cleanup
‚îú‚îÄ‚îÄ README.md               # üìñ Main documentation
‚îú‚îÄ‚îÄ requirements.txt        # üì¶ Unified Python dependencies
‚îú‚îÄ‚îÄ .env                    # ‚öôÔ∏è Environment configuration
‚îú‚îÄ‚îÄ .gitignore             # üö´ Git ignore patterns
‚îú‚îÄ‚îÄ docker-compose.yml     # üê≥ Docker configuration
‚îú‚îÄ‚îÄ 
‚îú‚îÄ‚îÄ frontend/               # üåê Next.js frontend
‚îÇ   ‚îú‚îÄ‚îÄ components/         # React components
‚îÇ   ‚îú‚îÄ‚îÄ pages/             # Next.js pages
‚îÇ   ‚îú‚îÄ‚îÄ styles/            # CSS styles
‚îÇ   ‚îú‚îÄ‚îÄ utils/             # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ types/             # TypeScript types
‚îÇ   ‚îú‚îÄ‚îÄ lib/               # Library files
‚îÇ   ‚îú‚îÄ‚îÄ package.json       # Node.js dependencies
‚îÇ   ‚îú‚îÄ‚îÄ package-lock.json  # Lock file
‚îÇ   ‚îú‚îÄ‚îÄ next.config.js     # Next.js configuration
‚îÇ   ‚îú‚îÄ‚îÄ tailwind.config.js # Tailwind CSS config
‚îÇ   ‚îú‚îÄ‚îÄ postcss.config.js  # PostCSS configuration
‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json      # TypeScript configuration
‚îú‚îÄ‚îÄ 
‚îú‚îÄ‚îÄ backend/                # üêç FastAPI backend
‚îÇ   ‚îú‚îÄ‚îÄ app/               # Application code
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters/      # External service adapters
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/           # API routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rag/           # GraphRAG implementations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/       # Pydantic models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store/         # Data storage
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/         # Utility functions
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py        # FastAPI application
‚îÇ   ‚îú‚îÄ‚îÄ data/              # Data files
‚îÇ   ‚îú‚îÄ‚îÄ logs/              # Log files
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt   # Python dependencies
‚îú‚îÄ‚îÄ 
‚îú‚îÄ‚îÄ scripts/                # üîß Utility scripts
‚îÇ   ‚îî‚îÄ‚îÄ load_mock_data.py  # Mock data loader
‚îú‚îÄ‚îÄ 
‚îú‚îÄ‚îÄ docs/                   # üìö Documentation
‚îÇ   ‚îú‚îÄ‚îÄ QUICK_START.md     # Quick setup guide
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md    # System architecture
‚îÇ   ‚îî‚îÄ‚îÄ DEPLOYMENT_GUIDE.md # Deployment guide
‚îî‚îÄ‚îÄ 
‚îî‚îÄ‚îÄ logs/                   # üìù Application logs
```

## ‚úÖ Cleanup Summary

- ‚úÖ Removed all test files and directories
- ‚úÖ Removed unnecessary build artifacts
- ‚úÖ Removed duplicate and backup files
- ‚úÖ Organized scripts and documentation
- ‚úÖ Updated .gitignore with comprehensive patterns
- ‚úÖ Created clean, production-ready structure

## üöÄ Ready for Use

The repository is now clean and organized for:
- Development
- Presentations
- Production deployment
- Collaboration

All unnecessary files have been removed and the structure is optimized for maintainability.
"""
    
    try:
        with open("PROJECT_STRUCTURE.md", 'w') as f:
            f.write(structure_content)
        print(f"{Colors.OKGREEN}‚úÖ Created PROJECT_STRUCTURE.md{Colors.ENDC}")
        return True
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå Failed to create PROJECT_STRUCTURE.md: {e}{Colors.ENDC}")
        return False

def run_git_cleanup():
    """Run git cleanup commands."""
    print(f"{Colors.OKCYAN}üîß Running git cleanup...{Colors.ENDC}")
    
    try:
        # Add all changes
        subprocess.run(["git", "add", "."], check=True)
        print("  ‚úÖ Added all changes to git")
        
        # Remove files from git cache that are now ignored
        subprocess.run(["git", "rm", "-r", "--cached", "."], check=True)
        subprocess.run(["git", "add", "."], check=True)
        print("  ‚úÖ Cleaned git cache")
        
        print(f"{Colors.OKGREEN}‚úÖ Git cleanup completed{Colors.ENDC}")
        return True
    except Exception as e:
        print(f"{Colors.WARNING}‚ö†Ô∏è  Git cleanup failed (not a git repo or no git): {e}{Colors.ENDC}")
        return True

def main():
    """Main cleanup function."""
    print_header()
    
    print(f"{Colors.OKCYAN}üöÄ Starting comprehensive cleanup process...{Colors.ENDC}")
    
    # Remove unnecessary directories
    remove_unnecessary_directories()
    
    # Remove unnecessary files
    remove_unnecessary_files()
    
    # Clean frontend directory
    clean_frontend_directory()
    
    # Clean backend directory
    clean_backend_directory()
    
    # Organize directories
    organize_directories()
    
    # Update .gitignore
    update_gitignore()
    
    # Create final structure documentation
    create_final_structure()
    
    # Run git cleanup
    run_git_cleanup()
    
    print(f"\n{Colors.OKGREEN}{Colors.BOLD}üéâ Comprehensive Cleanup Complete!{Colors.ENDC}")
    print(f"\n{Colors.OKBLUE}üìã Repository is now completely clean with:{Colors.ENDC}")
    print(f"‚úÖ All test files and directories removed")
    print(f"‚úÖ All unnecessary build artifacts removed")
    print(f"‚úÖ All duplicate and backup files removed")
    print(f"‚úÖ Clean, organized project structure")
    print(f"‚úÖ Comprehensive .gitignore")
    print(f"‚úÖ Production-ready organization")
    print(f"‚úÖ Documentation of final structure")
    print(f"\n{Colors.OKCYAN}üìö Ready for development, presentation, and production!{Colors.ENDC}")
    print(f"\n{Colors.WARNING}üí° Next steps:{Colors.ENDC}")
    print(f"1. Run: python setup.py (if needed)")
    print(f"2. Run: python start.py (to start the application)")
    print(f"3. Check PROJECT_STRUCTURE.md for the final organization")

if __name__ == "__main__":
    main()
